<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>daugia.vin — Đấu giá minh bạch trên Viction</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="64x64" href="vin64.png" />
  <link rel="apple-touch-icon" href="vin128.png" />

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Ethers (UMD v5) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <!-- ====== HEADER / NAV ====== -->
  <header class="nav">
    <div class="nav-left">
      <img src="vin128.png" alt="VIN" class="logo" />
      <div class="brand">
        <h1 class="site">daugia.vin</h1>
        <p class="tagline">Công bằng • Minh bạch • On-chain</p>
      </div>
    </div>

    <div class="nav-right">
      <!-- Giá VIN theo USD (BINANCE VICUSDT * 100) -->
      <div class="price-chip">
        1 VIN = <span id="vinUsd">Loading…</span> USD
      </div>

      <!-- Kết nối / Ngắt kết nối -->
      <button id="connectBtn" class="btn primary" data-state="disconnected">Kết nối ví</button>
      <div id="addrShort" class="addr" hidden>0x…</div>
    </div>
  </header>

  <!-- ====== THANH TÌM KIẾM (luôn hiển thị) ====== -->
  <main class="container">
    <section class="card">
      <div class="row search-row">
        <input id="searchQuery" type="text" placeholder="Tìm theo ID, nội dung, địa chỉ người tạo (0x…)" />
        <button id="btnSearch" class="btn">Tìm</button>
      </div>
    </section>

    <!-- ====== KHU VỰC VÍ (chỉ hiện sau khi kết nối) ====== -->
    <section id="walletArea" class="card" hidden>
      <div class="title-row">
        <h2>Ví của bạn</h2>
        <span id="walletAddrFull" class="mono small">—</span>
      </div>

      <div class="grid-2">
        <div class="box">
          <h3>Trạng thái</h3>
          <div class="balances" id="balancesBar" hidden>
            <span>VIC: <strong id="vicBalance">—</strong></span>
            <span>VIN: <strong id="vinBalance">—</strong></span>
          </div>
          <p class="muted small">Nếu chưa đăng ký, cần ký giao dịch thu phí VIN (theo phí nền tảng của hợp đồng).</p>
          <div class="actions">
            <button id="btnRegister" class="btn accent" hidden>Đăng ký</button>
            <span id="registerStatus" class="status"></span>
          </div>
        </div>

        <div class="box">
          <h3>Tạo cuộc đấu giá</h3>
          <p class="muted small">Mở biểu mẫu để đăng phiên mới.</p>
          <div class="actions">
            <button id="openCreateForm" class="btn">Tạo cuộc đấu giá</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== FORM TẠO CUỘC ĐẤU GIÁ (ẩn mặc định) ====== -->
    <section id="createForm" class="card" hidden>
      <h2>Đăng cuộc đấu giá mới</h2>
      <p class="muted">Giá & bước giá tính theo <strong>VND</strong>. Nội dung tối đa <strong>20.000</strong> ký tự.</p>

      <div class="grid-2">
        <div class="field">
          <label for="startTime">Thời gian bắt đầu</label>
          <input id="startTime" type="datetime-local" />
        </div>
        <div class="field">
          <label for="endTime">Thời gian kết thúc</label>
          <input id="endTime" type="datetime-local" />
        </div>
        <div class="field">
          <label for="depositCloseTime">Hạn cuối cập nhật ví đã đặt cọc</label>
          <input id="depositCloseTime" type="datetime-local" />
        </div>
        <div class="field">
          <label for="startPrice">Giá khởi điểm (VND)</label>
          <input id="startPrice" type="number" min="0" step="1" placeholder="VD: 1000000" />
        </div>
        <div class="field">
          <label for="minBidStep">Bước giá (VND)</label>
          <input id="minBidStep" type="number" min="0" step="1" placeholder="VD: 50000" />
        </div>
        <div class="field full">
          <label for="auctionContent">Nội dung đấu giá</label>
          <textarea id="auctionContent" rows="6" maxlength="20000" placeholder="Mô tả tài sản, điều kiện tham gia, giấy tờ, …"></textarea>
          <div class="muted small"><span id="contentCount">0</span>/20000</div>
        </div>
        <div class="field full">
          <label for="mediaLinks">Link hình ảnh / video (không bắt buộc)</label>
          <input id="mediaLinks" type="text" placeholder="Dán URL, nhiều link cách nhau bằng dấu phẩy" />
        </div>
      </div>

      <div class="actions">
        <button id="btnPublish" class="btn primary">Đăng</button>
        <span id="publishStatus" class="status"></span>
      </div>
    </section>

    <!-- ====== DANH SÁCH CUỘC ĐẤU GIÁ (dạng bài báo) ====== -->
    <section class="card">
      <div class="title-row">
        <h2>Cuộc đấu giá</h2>
        <div class="filters">
          <select id="filterState" title="Lọc trạng thái">
            <option value="all">Tất cả</option>
            <option value="upcoming">Chưa diễn ra</option>
            <option value="live">Đang diễn ra</option>
            <option value="ended">Đã kết thúc</option>
          </select>
          <button id="btnReload" class="btn">Tải lại</button>
        </div>
      </div>

      <!-- Danh sách “bài báo” -->
      <div id="auctionList" class="article-list">
        <!-- app.js sẽ render các <article class="auction-article"> vào đây -->
      </div>

      <!-- Phân trang theo lô: bấm để nạp thêm -->
      <div class="pagination" id="pagination">
        <button id="btnLoadMore" class="btn">Tải thêm</button>
        <span id="pageInfo" class="muted small">—</span>
      </div>
    </section>

    <!-- ====== TEMPLATE BÀI ĐẤU GIÁ ====== -->
    <template id="auctionArticleTpl">
      <article class="auction-article">
        <header class="a-head">
          <h3 class="a-title"></h3>
          <span class="badge a-status">—</span>
        </header>

        <div class="a-meta">
          <span>ID: <strong class="a-id">—</strong></span>
          <span class="sep">•</span>
          <span>Người tạo: <code class="a-creator mono">—</code></span>
          <span class="sep">•</span>
          <span>Bắt đầu: <time class="a-start">—</time></span>
          <span class="sep">•</span>
          <span>Kết thúc: <time class="a-end">—</time></span>
          <span class="sep">•</span>
          <span>Hạn cập nhật cọc: <time class="a-deadline">—</time></span>
          <span class="sep">•</span>
          <span>Giá khởi điểm: <strong class="a-startprice">—</strong> VND</span>
          <span class="sep">•</span>
          <span>Bước giá: <strong class="a-step">—</strong> VND</span>
          <span class="sep">•</span>
          <span>Giá hiện thời: <strong class="a-current">—</strong> VND</span>
          <span class="sep">•</span>
          <span>Số ví đã đặt cọc: <strong class="a-whitelist">—</strong></span>
        </div>

        <div class="a-body multiline"></div>

        <div class="a-media" hidden>
          <!-- app.js có thể render danh sách link <a>... -->
        </div>

        <!-- Khu hành động: ẨN MẶC ĐỊNH.
             app.js sẽ quyết định khi nào hiện:
             - .a-join: ai cũng có thể bấm sau khi kết nối (hoặc cho mọi người tuỳ anh)
             - .a-bid: chỉ hiện khi ví thuộc whitelist & phiên đang ACTIVE
             - .a-update: chỉ hiện cho creator & trước hạn depositCutoff -->
        <div class="actions a-actions" hidden>
          <button class="btn a-join" hidden>Tham gia</button>
          <div class="inline-bid a-bidwrap" hidden>
            <input type="number" class="inline-input a-bidinput" min="0" step="1" placeholder="Nhập giá (VND)" />
            <button class="btn primary a-bid" hidden>Bỏ giá</button>
          </div>
          <button class="btn ghost a-update" hidden>Cập nhật ví đã đặt cọc</button>
        </div>
      </article>
    </template>
  </main>

  <!-- ====== FOOTER (đưa link điều hướng xuống chân trang) ====== -->
  <footer class="footer">
    <nav class="footnav">
      <a id="linkSwap" target="_blank" rel="noopener">Swap VIN/VIC</a>
      <span class="sep">•</span>
      <a id="linkAuctionC" target="_blank" rel="noopener">Hợp đồng đấu giá</a>
      <span class="sep">•</span>
      <a id="linkVinToken" target="_blank" rel="noopener">VIN Token</a>
      <span class="sep">•</span>
      <a id="linkGuide" target="_blank" rel="noopener">Hướng dẫn</a>
    </nav>
    <div class="copy">© <span id="yearNow"></span> daugia.vin</div>
  </footer>

  <!-- ====== CẤU HÌNH ====== -->
  <script>
    window.DAUGIA_CFG = {
      CHAIN_ID_HEX: "0x58", // 88
      RPC_URL: "https://rpc.viction.xyz",
      EXPLORER: "https://vicscan.xyz",
      AUCTION_ADDR: "0x1765e20ecB8cD78688417A6d4123f2b899775599",
      VIN_ADDR:     "0x941F63807401efCE8afe3C9d88d368bAA287Fac4",
      SWAP_URL:     "https://fortunerolls.github.io/vicdex"
    };
  </script>

  <!-- ====== SCRIPT NHẸ (giá VIN, link chân trang, đếm ký tự) ====== -->
  <script>
    document.getElementById("yearNow").textContent = new Date().getFullYear();

    (function initFooterLinks(){
      const { EXPLORER, AUCTION_ADDR, VIN_ADDR, SWAP_URL } = window.DAUGIA_CFG;
      const addrLink = (b,a) => `${b}/address/${a}`;
      document.getElementById("linkAuctionC").href = addrLink(EXPLORER, AUCTION_ADDR);
      document.getElementById("linkVinToken").href = addrLink(EXPLORER, VIN_ADDR);
      document.getElementById("linkSwap").href     = SWAP_URL;
      document.getElementById("linkGuide").href    = "#"; // trỏ tới tài liệu khi sẵn sàng
    })();

    async function updateVinUsd(){
      const el = document.getElementById("vinUsd");
      try{
        const r = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=VICUSDT",{cache:"no-store"});
        const j = await r.json();
        const vic = parseFloat(j.price||"0");
        if(!isFinite(vic)||vic<=0) throw new Error();
        el.textContent = (vic*100).toFixed(2);
      }catch{ el.textContent = "N/A"; }
    }
    updateVinUsd(); setInterval(updateVinUsd, 60000);

    const contentEl = document.getElementById("auctionContent");
    if(contentEl){
      const cnt = document.getElementById("contentCount");
      const sync = ()=> cnt.textContent = String(contentEl.value.length);
      contentEl.addEventListener("input", sync); sync();
    }
  </script>

  <!-- App logic -->
  <script src="app.js"></script>

  <!-- ====== STYLES NHỎ CHO “BÀI BÁO” (tận dụng theme hiện có) ====== -->
  <style>
    .article-list{ display:flex; flex-direction:column; gap:1rem; }
    .auction-article{
      background:#0c1426; border:1px solid var(--border); border-radius:1rem; padding:1rem 1rem 1.2rem;
      box-shadow: var(--shadow);
    }
    .a-head{ display:flex; align-items:center; gap:.6rem; }
    .a-title{ margin:0; font-size:1.15rem; }
    .a-meta{
      margin:.35rem 0 .6rem; display:flex; flex-wrap:wrap; gap:.4rem .6rem; color:var(--text-dim);
    }
    .a-body{ font-size:1rem; line-height:1.75; padding-top:.25rem; }
    .a-media{ margin-top:.6rem; display:flex; flex-wrap:wrap; gap:.4rem .6rem; }
    .a-media a{ text-decoration: underline; }
    .a-actions{ margin-top: .9rem; }
  </style>
</body>
</html>
